<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            crossorigin="anonymous"
        />
        <title>apply - MyPortfolio</title>
    </head>
    <body>
        <div id="navbar"></div>
        <script src="navi.js"></script>
        
        <div class="container mt-4">
            <h2 class="mb-3">Apply Your Portfolio</h2>
            <form id="portfolio-form">
                <div class="mb-3 row">
                    <div class="col-md-8">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="8" placeholder="name, email, phone number etc"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label for="photo-upload" class="form-label">Upload Photo</label>
                        <input type="file" class="form-control" id="photo-upload">
                        <div id="image-preview" class="mt-2" style="height: auto; width: 300px;"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="history" class="form-label">History Title</label>
                    <input type="text" class="form-control" id="history" placeholder="History">
                    <button type="button" id="add-btn" class="btn btn-secondary mt-2">Add</button>
                </div>

            </form>
            <div id="histories" class="mt-4"></div>
            <div class="d-flex justify-content-end">
                <button type="submit" id="submit-btn" class="btn btn-primary">Submit</button>
            </div>
        </div>  
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const photoUpload = document.querySelector('#photo-upload');
                const imagePreview = document.querySelector('#image-preview');
                const historyInput = document.querySelector('#history');
                const addBtn = document.querySelector('#add-btn');
                const historiesDiv = document.querySelector('#histories');
                const histories = [];
        
                photoUpload.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        var reader = new FileReader();

                        reader.onload = function(e) {
                            imagePreview.innerHTML = '<img src="' + e.target.result + '" class="img-fluid" />';
                        };

                        reader.readAsDataURL(this.files[0]);
                    }
                });
        
                addBtn.addEventListener('click', function() {
                    const historyTitle = historyInput.value;
                    if (historyTitle) {
                        const newHistory = {
                            title: historyTitle,
                            text: [],
                            url: []
                        };
        
                        const historySection = document.createElement('div');
                        historySection.classList.add('history-section');
                        historySection.innerHTML = `
                            <h3>${historyTitle} <button class="delete-history-btn btn btn-sm btn-danger">Delete</button></h3>
                            <ul class="history-list"></ul>
                            <input type="text" class="history-item-input" placeholder="Add history">
                            <input type="text" class="history-item-url-input" placeholder="URL (optional)">
                            <button class="add-history-item-btn btn btn-sm btn-primary mt-2">Add history</button>
                        `;
                        historiesDiv.appendChild(historySection);
        
                        const deleteHistoryBtn = historySection.querySelector('.delete-history-btn');
                        deleteHistoryBtn.addEventListener('click', function() {
                            historySection.remove();
                            histories.splice(histories.indexOf(newHistory), 1);
                        });
        
                        const addItemBtn = historySection.querySelector('.add-history-item-btn');
                        const itemInput = historySection.querySelector('.history-item-input');
                        const urlInput = historySection.querySelector('.history-item-url-input');
                        const historyList = historySection.querySelector('.history-list');
        
                        addItemBtn.addEventListener('click', function() {
                            const itemText = itemInput.value;
                            const itemUrl = urlInput.value;
                            if (itemText) {
                                newHistory.text.push(itemText);
                                newHistory.url.push(itemUrl);
        
                                const listItem = document.createElement('li');
                                listItem.textContent = itemText + (itemUrl ? `: ${itemUrl}` : '');
        
                                const deleteItemBtn = document.createElement('button');
                                deleteItemBtn.textContent = 'Delete';
                                deleteItemBtn.classList.add('btn', 'btn-sm', 'btn-danger', 'ml-2');
                                deleteItemBtn.onclick = function() {
                                    const index = newHistory.text.indexOf(itemText);
                                    newHistory.text.splice(index, 1);
                                    newHistory.url.splice(index, 1);
                                    listItem.remove();
                                };
        
                                listItem.appendChild(deleteItemBtn);
                                historyList.appendChild(listItem);
        
                                itemInput.value = '';
                                urlInput.value = '';
                            }
                        });
        
                        histories.push(newHistory);
                        historyInput.value = '';
                    }
                });
            });
        </script>
        



    <!-- firebase  -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js';
        import {
            getAuth, // authentication 설정
            onAuthStateChanged, //state change method
        } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js';
        import {getFirestore, doc, setDoc} from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js';
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: 'AIzaSyCewXKX4dEBB-Lrh4ymr_EOcn1Jdw3_pUk',
            authDomain: 'opensource-project-b2d2f.firebaseapp.com',
            projectId: 'opensource-project-b2d2f',
            storageBucket: 'opensource-project-b2d2f.appspot.com',
            messagingSenderId: '857335827397',
            appId: '1:857335827397:web:64711d1e837f9264f199ac',
            measurementId: 'G-6MPQYRFD68',
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        
        const auth = getAuth();
        const firestore = getFirestore(app);   
        //로그인 상태 확인
        onAuthStateChanged(auth, (user) => {
            // 사용자가 로그인한 상태
            if (user) {
                console.log('User is signed in:', user);
                // 여기서 원하는 로그인 상태를 처리
                //로그아웃 버튼을 nav에 추가 추가
                const navbar_log = document.querySelector('#nav-log');
                console.log(navbar_log);
                navbar_log.textContent = 'Log Out';
                const logoutButton = document.getElementById('nav-log');

                //로그아웃 버튼을 누른 경우
                logoutButton.addEventListener('click', (e) => {
                    //로그아웃 버튼을 눌렀을때 동작 추가하기
                    if (navbar_log.textContent === 'Log Out') {
                        navbar_log.textContent = 'Log In';

                        e.preventDefault();
                        auth.signOut().then(() => {
                            alert('logout');
                        });
                    } else if (navbar_log.textContent === 'Log In') {
                        window.location.href = 'login.html';
                    }
                });
            }
            // 사용자가 로그아웃한 상태
            else {
                console.log('User is signed out');
                //여기서 원하는 로그아웃 상태를 처리
                const navbar_log = document.querySelector('#nav-log');
                navbar_log.textContent = 'Log In';
                window.location.href = 'login.html';
            }
            const specialOfTheDay=doc(firestore, 'Data', user.email);
            
            //firestore에 정보 세팅 및 저장
            async function writeDailySpecial(){
                const description = document.querySelector('#description').value;
                const imageElement = document.querySelector('#image-preview img');
                const image = imageElement ? imageElement.src : '';
                const historiesData = Array.from(document.querySelectorAll('.history-section')).map(section => {
                        const title = section.querySelector('h3').textContent.replace(' Delete', ''); // 'Delete' 텍스트 제거
                        const items = Array.from(section.querySelectorAll('.history-list li')).map(li => {
                            return {
                                text: li.childNodes[0].nodeValue.trim(), // 텍스트 내용
                                url: li.querySelector('a') ? li.querySelector('a').href : '' // URL
                            };
                        });
                        return { title, items };
                    });

                const docData={
                    description,
                    image,
                    histroes:historiesData
                }

                //description input 박스안에 있는 text를 firestore에 저장
                const descriptiontext=document.querySelector('#description').value;
                docData.description=descriptiontext;

                //image 칸의 박스 안에 있는 그림 정보를 firestore에 저장
                const imageInfo=document.querySelector('img');
                if(imageInfo!==null){
                    docData.image=imageInfo.src;
                }
                
                await setDoc(specialOfTheDay, docData);

            }

            const SubmitButton=document.querySelector('#submit-btn');
            
            SubmitButton.addEventListener('click',()=>{
                writeDailySpecial().then(()=>{
                    window.location.href = 'index.html';
                })
            })
        });

    </script>
</html>